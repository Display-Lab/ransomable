---
- hosts: all
  become: true
  tags:
    - core
  remote_user: ubuntu
  gather_facts: no
  pre_tasks:
  - name: install python
    raw: bash -c "test -e /usr/bin/python || (apt -qqy update && apt install -qqy python python-pip)"
    register: output
    changed_when: output.stdout != ""

- hosts: all
  become: true
  tags:
    - core
  remote_user: ubuntu
  gather_facts: yes
  tasks:
    - name: Add ipv4 hostname to /etc/hosts
      lineinfile:
        path: /etc/hosts
        state: present
        line: "127.0.0.1 {{ansible_hostname}}"
    - name: Install aptitude
      apt:
        name: aptitude
        state: present
    - name: Upgrade all system packages to the latest version
      apt:
        name: "*"
        state: latest
# Copied out of https://github.com/savoirfairelinux/ansible-reboot-if-needed/blob/master/tasks/main.yml
    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required_file
    - name: Rebooting machine
      shell: sleep 2 && shutdown -r now "Ansible updates triggered"
      async: 1
      poll: 0
      ignore_errors: true
      when: reboot_required_file.stat.exists
    - name: Waiting for the machine to come back
      local_action: 
        module: wait_for
        host: "{{ansible_host}}"
        port: "{{ansible_port}}" 
        state: started
        delay: 20
        timeout: 300
      become: no
      when: reboot_required_file.stat.exists

- hosts: reports
  become: true
  tags:
    - R
    - apt
  tasks:
    - name: Install a list of system packages
      apt:
        name: "{{ packages }}"
      vars:
        packages:
        - pandoc
        - curl
        - libcurl4
        - libcurl4-openssl-dev
        - git
        - mysql-client

- hosts: reports
  become: true
  tags:
    - R
  tasks:
    - include_role:
        name: oefenweb.r
      vars:
        r_install_dev: true
        r_install:
          - r-recommended
        r_packages:
          - name: bookdown
          - name: dplyr
          - name: DT
          - name: htmltools
          - name: ggplot2
          - name: ggthemes
          - name: rmarkdown
          - name: scales
          - name: stringr
          - name: tinytex
          - name: viridis
          - name: purrr
          - name: tidyr
          - name: knitr
          - name: lubridate
          - name: RColorBrewer
          - name: forcats
          - name: glue
          - name: gridExtra
          - name: tidyverse

- hosts: reports
  become: yes
  tags:
    - R
  tasks:
    - name: Create rusers group
      group:
        name: rusers
        state: present
    - name: Add ubuntu user to group
      user:
        name: ubuntu
        groups: rusers
        append: yes

- hosts: reports
  become: yes
  tags:
    - R
  tasks: 
    - name: R lib permissions
      file:
        path: "{{ item }}"
        group: rusers
        mode: "2775"
        recurse: yes
        state: directory
      with_items:
        - "/usr/local/lib/R/site-library"
        - "/usr/lib/R/site-library"
        - "/usr/lib/R/library"

- hosts: reports
  tags:
    - ruby
    - apt
  gather_facts: true # https://github.com/zzet/ansible-rbenv-role/issues/37
  vars:
    rbenv:
      env: user
      version: v1.1.1
      default_ruby: 2.5.1
      rubies:
      - version: 2.5.1
        env:
          RUBY_CONFIGURE_OPTS: "--disable-install-doc --enable-shared --with-jemalloc"
    rbenv_extra_depends:
      - libjemalloc1
      - libjemalloc-dev
  roles:
    - role: zzet.rbenv
      rbenv_users:
        - ubuntu

#- hosts: reports
#  become: yes
#  tags:
#    - systemd
#    - timer
#  roles:
#    - role: data.retrieval
